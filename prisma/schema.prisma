generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ─── Bills ────────────────────────────────────────────────────────────────────

model Bill {
  id                 String   @id @default(cuid())
  parliamentId       Int      @unique
  shortTitle         String
  longTitle          String
  billTypeId         Int?
  billTypeName       String?
  billTypeCategory   String?  // "Government" | "Private Members'" | "Private"
  currentHouse       String?  // "Commons" | "Lords" | "Unassigned"
  currentStage       String?
  originatingHouse   String?
  lastUpdate         DateTime?
  isAct              Boolean  @default(false)
  isDefeated         Boolean  @default(false)
  billWithdrawn      DateTime?
  sessionId          Int?
  sessionName        String?
  policyTopics       String[] @default([])
  affectedGroups     String[] @default([])
  legislationGovUrl  String?

  stages             BillStage[]
  sponsors           BillSponsor[]
  publications       BillPublication[]
  summaries          BillSummary[]
  divisions          Division[]
  trackedBills       TrackedBill[]
  notifications      Notification[]

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([currentHouse])
  @@index([billTypeName])
  @@index([isAct])
  @@index([lastUpdate])
}

model BillStage {
  id            String    @id @default(cuid())
  billId        String
  bill          Bill      @relation(fields: [billId], references: [id], onDelete: Cascade)
  stageId       Int
  stageName     String
  house         String    // "Commons" | "Lords"
  sortOrder     Int       @default(0)
  sittingDate   DateTime?
  description   String?

  createdAt     DateTime  @default(now())

  @@unique([billId, stageId])
  @@index([billId])
}

model BillSponsor {
  id            String  @id @default(cuid())
  billId        String
  bill          Bill    @relation(fields: [billId], references: [id], onDelete: Cascade)
  memberId      Int?
  name          String
  party         String?
  constituency  String?
  photoUrl      String?
  sortOrder     Int     @default(0)

  @@index([billId])
}

model BillPublication {
  id              String  @id @default(cuid())
  billId          String
  bill            Bill    @relation(fields: [billId], references: [id], onDelete: Cascade)
  publicationType String  // "Bill text" | "Amendment paper" | "Explanatory notes" etc.
  title           String
  url             String
  displayDate     DateTime?

  createdAt       DateTime @default(now())

  @@index([billId])
}

// ─── AI Summaries ──────────────────────────────────────────────────────────────

model BillSummary {
  id          String   @id @default(cuid())
  billId      String
  bill        Bill     @relation(fields: [billId], references: [id], onDelete: Cascade)
  language    String   @default("en")
  version     Int      @default(1)

  // Structured summary JSON
  overview    String   // Plain-English overview
  purpose     String   // Why this bill exists
  keyChanges  Json     // string[] - Major changes proposed
  impacts     Json     // { group: string, impact: string }[]
  implementation String? // Timeline / how it would be implemented
  tldr        String   // One-sentence summary

  modelUsed   String   @default("claude-sonnet-4-5-20250929")
  tokensUsed  Int?
  generatedAt DateTime @default(now())

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([billId, language, version])
  @@index([billId])
}

// ─── Users & Auth ─────────────────────────────────────────────────────────────

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  preferredLang String   @default("en")
  theme         String   @default("dark")

  sessions          Session[]
  trackedBills      TrackedBill[]
  pushSubscriptions PushSubscription[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model VerificationCode {
  id        String    @id @default(cuid())
  email     String
  code      String
  expiresAt DateTime
  attempts  Int       @default(0)
  usedAt    DateTime?

  createdAt DateTime  @default(now())

  @@index([email])
  @@index([code, email])
}

// ─── Tracking ─────────────────────────────────────────────────────────────────

model TrackedBill {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  billId          String
  bill            Bill     @relation(fields: [billId], references: [id], onDelete: Cascade)

  notifyStageChange  Boolean @default(true)
  notifyRoyalAssent  Boolean @default(true)
  notifyNewAmendment Boolean @default(false)

  createdAt       DateTime @default(now())

  @@unique([userId, billId])
  @@index([userId])
  @@index([billId])
}

model PushSubscription {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  endpoint   String   @unique
  p256dh     String
  auth       String

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([userId])
}

// ─── Divisions (Votes) ──────────────────────────────────────────────────────────

model Division {
  id              String   @id @default(cuid())
  billId          String
  bill            Bill     @relation(fields: [billId], references: [id], onDelete: Cascade)
  house           String   // "Commons" | "Lords"
  divisionId      Int      // Parliament API division ID
  divisionNumber  Int?     // Division number within session
  title           String
  date            DateTime
  ayeCount        Int
  noCount         Int
  abstainCount    Int      @default(0)
  noVoteCount     Int      @default(0)
  isDeferred      Boolean  @default(false)
  stageName       String?  // e.g. "2nd Reading", "Report Stage"

  votes           MemberVote[]

  createdAt       DateTime @default(now())

  @@unique([house, divisionId])
  @@index([billId])
  @@index([date])
}

model MemberVote {
  id            String   @id @default(cuid())
  divisionId    String
  division      Division @relation(fields: [divisionId], references: [id], onDelete: Cascade)
  memberId      Int      // Parliament member ID
  memberName    String
  party         String?
  constituency  String?  // "memberFrom" in API
  lobby         String   // "Aye" | "No" | "Abstain"
  isTeller      Boolean  @default(false)

  @@unique([divisionId, memberId])
  @@index([divisionId])
  @@index([memberId])
  @@index([party])
}

// ─── Notifications ──────────────────────────────────────────────────────────────

enum NotificationType {
  STAGE_CHANGE
  ROYAL_ASSENT
  NEW_BILL
  NEW_AMENDMENT
  BILL_DEFEATED
  BILL_WITHDRAWN
}

model Notification {
  id         String           @id @default(cuid())
  billId     String
  bill       Bill             @relation(fields: [billId], references: [id], onDelete: Cascade)
  type       NotificationType
  title      String
  body       String
  data       Json?
  sentAt     DateTime         @default(now())

  @@index([billId])
  @@index([sentAt])
}

// ─── Sync Log ────────────────────────────────────────────────────────────────────

model SyncLog {
  id          String   @id @default(cuid())
  jobName     String
  status      String   // "started" | "completed" | "failed"
  billsFound  Int?
  billsSynced Int?
  error       String?
  startedAt   DateTime @default(now())
  completedAt DateTime?
}
